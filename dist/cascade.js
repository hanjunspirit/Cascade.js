!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var e;e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,e.Cascade=t()}}(function(){return function t(e,a,i){function n(r,o){if(!a[r]){if(!e[r]){var c="function"==typeof require&&require;if(!o&&c)return c(r,!0);if(s)return s(r,!0);var u=new Error("Cannot find module '"+r+"'");throw u.code="MODULE_NOT_FOUND",u}var l=a[r]={exports:{}};e[r][0].call(l.exports,function(t){var a=e[r][1][t];return n(a?a:t)},l,l.exports,t,e,a,i)}return a[r].exports}for(var s="function"==typeof require&&require,r=0;r<i.length;r++)n(i[r]);return n}({1:[function(t,e,a){function i(t,e,a){c.arrayForEach(a,function(a){(t[a]=t[a]||[]).push(e)})}function n(t,e){c.arrayForEach(e,function(e){t.hasOwnProperty(e)||c.error("The dependency ["+e+"] does not exist")})}function s(t){var e=[].concat(t.deps);return t instanceof r&&t.initialDeps&&c.arrayForEach(t.initialDeps,function(t){c.arrayIndexOf(e,t)===-1&&e.push(t)}),e}var r=(t("./nodes/CascadeNode"),t("./nodes/CascadeDataState")),o=(t("./nodes/CascadeDataDerive"),t("./nodes/CascadeWait")),c=t("./helper/util"),u={reinitializeNodesManager:function(){this.statesObj=this.statesObj||{},this.impactGraph=this.impactGraph||{}},addNode:function(t){this.statesObj.hasOwnProperty(t.name)&&c.error("The state or drived data ["+t.name+"] is already defined");var e=s(t);n(this.statesObj,e),this.statesObj[t.name]=t,i(this.impactGraph,t.name,e)},removeNode:function(t){this.statesObj.hasOwnProperty(t)||c.error("You can not removeNode ["+t+"], because it does not exist");var e=this.statesObj[t];if(e&&e instanceof o){var a=this;c.arrayForEach(e.deps,function(t){var i=a.impactGraph[t];c.arrayRemove(i||[],e.name)}),delete this.statesObj[e.name]}else c.error("You can only remove CascadeWait object")},removeInitialDeps:function(t){this.statesObj.hasOwnProperty(t)||c.error("You can not removeInitialDeps ["+t+"], because it does not exist");var e=this.statesObj[t];if(e instanceof r){var a=[];c.arrayForEach(e.initialDeps,function(t){c.arrayIndexOf(e.deps,t)===-1&&a.push(t)}),delete e.initialDeps,delete e.initialFactory;var i=this;c.arrayForEach(a,function(t){var a=i.impactGraph[t];c.arrayRemove(a||[],e.name)})}else c.error("You can only remove initialDeps of a CascadeDataState object")},getChildren:function(t){var e=this,a=[].concat(this.impactGraph[t]||[]);return c.arrayForEach(a,function(t){c.arrayForEach(e.getChildren(t),function(t){c.arrayIndexOf(a,t)===-1&&a.push(t)})}),a}};e.exports={Mixin:u}},{"./helper/util":5,"./nodes/CascadeDataDerive":6,"./nodes/CascadeDataState":7,"./nodes/CascadeNode":8,"./nodes/CascadeWait":9}],2:[function(t,e,a){/**
 * @preserve Cascade.js
 *
 * @version 1.1.0
 * @copyright The Financial Times Limited [All Rights Reserved]
 * @license https://github.com/hanjunspirit/cascade.js/blob/master/LICENSE
 */
"use strict";function i(){this.states={},this._waitIdx=0,this.subscribers=[],this.reinitializeTransaction(),this.reinitializeNodesManager()}function n(){}function s(t){return t instanceof o}var r=t("./helper/Transaction"),o=t("./helper/UglyPromise"),c=t("./helper/util"),u=(t("./nodes/CascadeNode"),t("./nodes/CascadeDataState")),l=t("./nodes/CascadeDataDerive"),h=t("./nodes/CascadeWait"),f=t("./NodesManager");c.assign(i.prototype,r.Mixin,f.Mixin,{define:function(t,e,a,i,n){this.addNode(new u(t,e,a,i,n)),this.batchedUpdate(function(){this.adjust(t),this.updatedStates[t]=this.getState(t)})},derive:function(t,e,a){this.addNode(new l(t,e,a)),this.batchedUpdate(function(){this.adjust(t),this.updatedStates[t]=this.getState(t)})},wait:function(t,e){var a="__wait__"+this._waitIdx++;this.addNode(new h(a,t,e)),this.batchedUpdate(function(){this.adjust(a)})},forceUpdate:function(t){var e=this.statesObj[t];e&&e.isClean()&&(e.setDirty(),this.batchedUpdate(function(){this.adjust(t)}))},getStates:function(){var t={};for(var e in this.statesObj){var a=this.statesObj[e];a instanceof h||(t[e]=a.isClean()?this.states[e]:null)}return t},getState:function(t){var e=this.statesObj[t];return!e||!e.isClean()||e instanceof h?null:this.states[t]},setState:function(t,e){var a=this.statesObj[t];if(a){if(a instanceof l&&c.error("You can not set a derived data!"),a.isPending())return void c.warning("You can't set a pending state!");var i=a.definition,n=this.states[t];this.states[t]=i.setter(e,n),this.batchedUpdate(function(){n!==this.states[t]&&(this.updatedStates[t]=this.states[t],this._adjustChildren(t))},this)}},_adjustChildren:function(t){var e=this.getChildren(t),a=this;c.arrayForEach(e,function(t){a.statesObj[t].setDirty()}),c.arrayForEach(e,function(t){a.adjust(t),!a.statesObj[t]||a.statesObj[t]instanceof h||(a.updatedStates[t]=a.getState(t))})},adjust:function(t){var e=this.statesObj[t];if(e.isDirty()){if(!this._isInTransaction)return void c.error("adjust calls must be in Transaction");var a=e.deps;e instanceof u&&e.hasOwnProperty("initialFactory")&&(a=a.concat(e.initialDeps));var r=this;if(c.arraySome(a,function(t){return r.adjust(t),r.statesObj[t].isPending()}))e.setPending();else if(e instanceof u){var o=c.arrayMap(e.deps,function(t){return r.states[t]}),f=e.definition="function"!=typeof e.factory?i.types.Fixed(e.factory):e.factory.apply(null,o);if(f instanceof n||c.error("Empty definition in state"+t),e.hasOwnProperty("initialFactory")){if("function"==typeof e.initialFactory)var d=c.arrayMap(e.initialDeps,function(t){return r.states[t]}),p=e.initialFactory.apply(null,d);else var p=e.initialFactory;this.states[t]=f.setter(p),this.removeInitialDeps(t)}else this.states[t]=f.setter(this.states[t]);e.setClean()}else if(e instanceof l){var o=c.arrayMap(e.deps,function(t){return r.states[t]}),y=this.states[t]=e.factory.apply(null,o);if(s(y)){var v=function(a){y===r.states[t]&&r.batchedUpdate(function(){this.states[t]=a,this.updatedStates[t]=this.states[t],e.setDirty(),e.setClean(),this._adjustChildren(t)})};y.then(function(t){return v(t)},function(){return v(null)}),e.setPending()}else e.setClean()}else e instanceof h&&("function"==typeof e.factory&&this.waitToExecs.push(function(){var t=c.arrayMap(e.deps,function(t){return r.states[t]});e.factory.apply(null,t)}),this.removeNode(t))}},batchedUpdate:function(t){this._isInTransaction?t.call(this):this.perform(t,this)},subscribe:function(t){c.arrayIndexOf(this.subscribers,t)===-1&&this.subscribers.push(t)},unsubscribe:function(t){var e=c.arrayIndexOf(this.subscribers,t);e!==-1&&this.subscribers.splice(e,1)},getTransactionWrappers:function(){return[d,p]}});var d={initialize:function(){this.waitToExecs=[]},close:function(){for(var t;t=this.waitToExecs.shift();)t()}},p={initialize:function(){this.updatedStates={}},close:function(){var t=0;for(var e in this.updatedStates)t++;if(t>0){var a=this;c.arrayForEach(this.subscribers,function(t){t(a.updatedStates)})}this.updatedStates={}}};i.extendDataType=function(t){function e(t){this.args=t}return e.prototype={setter:function(e,a){return t.apply(null,[e,a].concat(this.args))}},c.extendClass(e,n),function(){return new e(Array.prototype.slice.call(arguments))}},i.types={},i.types.Fixed=i.extendDataType(function(t,e,a){return a}),i.types.Any=i.extendDataType(function(t,e){return t}),i.types.Enum=i.extendDataType(function(t,e,a){return c.arrayIndexOf(a,t)!==-1?t:void 0!==e?e:a[0]}),i.async=function(t){return new o(t)},e.exports=i},{"./NodesManager":1,"./helper/Transaction":3,"./helper/UglyPromise":4,"./helper/util":5,"./nodes/CascadeDataDerive":6,"./nodes/CascadeDataState":7,"./nodes/CascadeNode":8,"./nodes/CascadeWait":9}],3:[function(t,e,a){"use strict";var i={reinitializeTransaction:function(){this.transactionWrappers=this.getTransactionWrappers(),this.wrapperInitData?this.wrapperInitData.length=0:this.wrapperInitData=[],this._isInTransaction=!1},_isInTransaction:!1,getTransactionWrappers:null,isInTransaction:function(){return!!this._isInTransaction},perform:function(t,e,a,i,n,s,r,o){var c,u;try{this._isInTransaction=!0,c=!0,this.initializeAll(0),u=t.call(e,a,i,n,s,r,o),c=!1}finally{try{if(c)try{this.closeAll(0)}catch(t){}else this.closeAll(0)}finally{this._isInTransaction=!1}}return u},initializeAll:function(t){for(var e=this.transactionWrappers,a=t;a<e.length;a++){var i=e[a];try{this.wrapperInitData[a]=n.OBSERVED_ERROR,this.wrapperInitData[a]=i.initialize?i.initialize.call(this):null}finally{if(this.wrapperInitData[a]===n.OBSERVED_ERROR)try{this.initializeAll(a+1)}catch(t){}}}},closeAll:function(t){for(var e=this.transactionWrappers,a=t;a<e.length;a++){var i,s=e[a],r=this.wrapperInitData[a];try{i=!0,r!==n.OBSERVED_ERROR&&s.close&&s.close.call(this,r),i=!1}finally{if(i)try{this.closeAll(a+1)}catch(t){}}}this.wrapperInitData.length=0}},n={Mixin:i,OBSERVED_ERROR:{}};e.exports=n},{}],4:[function(t,e,a){function i(t){function e(t){a.status="Resolved",a.resolvedValue=t;for(var e=0;e<a.onResolveCallback.length;e++)a.onResolveCallback[e].call(null,t);a.onResolveCallback[e]=[]}this.status="Pending",this.onResolveCallback=[],this.resolvedValue=null;var a=this;t(e)}i.prototype.then=function(t){"Pending"===this.status?t&&this.onResolveCallback.push(t):t&&t.call(null,this.resolvedValue)},e.exports=i},{}],5:[function(t,e,a){function i(t){"undefined"!=typeof console&&console.warn(t)}function n(t){throw new Error(t)}function s(t,e){for(var a=0;a<t.length;a++)e(t[a],a)}function r(t,e){for(var a=0;a<t.length;a++)if(e(t[a],a))return!0;return!1}function o(t,e){var a=[];return s(t,function(t,i){a.push(e(t,i))}),a}function c(t,e){for(var a=0;a<t.length;a++)if(t[a]===e)return a;return-1}function u(t,e){var a=c(t,e);a!==-1&&t.splice(a,1)}function l(t){s(Array.prototype.slice.call(arguments,1),function(e){for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a])})}function h(t,e){var a=function(){};a.prototype=e.prototype;var i=new a;l(i,t.prototype),t.prototype=i,t.prototype.constructor=t}e.exports={warning:i,error:n,arrayForEach:s,arraySome:r,arrayMap:o,arrayIndexOf:c,arrayRemove:u,assign:l,extendClass:h}},{}],6:[function(t,e,a){function i(t,e,a){s.call(this,t,e),t||n.error("The [name] param of derive api is invalid"),this.deps.length||n.error('The [deps] param of derive("'+t+'", ...) api should not be empty'),"function"!=typeof a&&n.error('The [factory] param of derive("'+t+'", ...) api should be a function'),this.factory=a}var n=t("../helper/util"),s=t("./CascadeNode");n.assign(i.prototype,s.prototype),e.exports=i},{"../helper/util":5,"./CascadeNode":8}],7:[function(t,e,a){function i(t,e,a,i,r){s.call(this,t,e),t||n.error("The [name] param of define api is invalid"),void 0===a&&n.error('The [factory] param of define("'+t+'", ...) api is invalid'),this.factory=a,void 0!==r&&(this.initialDeps=i||[],this.initialFactory=r),this.definition=null}var n=t("../helper/util"),s=t("./CascadeNode");n.assign(i.prototype,s.prototype),e.exports=i},{"../helper/util":5,"./CascadeNode":8}],8:[function(t,e,a){function i(t,e){this.name=t,this.deps=e||[],this.status=n.DIRTY}i.prototype={setDirty:function(){this.status=n.DIRTY},setPending:function(){this.status===n.DIRTY&&(this.status=n.PENDING)},setClean:function(){this.status===n.DIRTY&&(this.status=n.CLEAN)},isClean:function(){return this.status===n.CLEAN},isPending:function(){return this.status===n.PENDING},isDirty:function(){return this.status===n.DIRTY}};var n={DIRTY:1,CLEAN:2,PENDING:3};e.exports=i},{}],9:[function(t,e,a){function i(t,e,a){s.call(this,t,e),this.deps.length||n.error("The [deps] param of wait api should not be empty"),this.factory=a}var n=t("../helper/util"),s=t("./CascadeNode");n.assign(i.prototype,s.prototype),e.exports=i},{"../helper/util":5,"./CascadeNode":8}]},{},[2])(2)});
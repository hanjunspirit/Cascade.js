!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var e;e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,e.Cascade=t()}}(function(){return function t(e,n,a){function i(r,o){if(!n[r]){if(!e[r]){var c="function"==typeof require&&require;if(!o&&c)return c(r,!0);if(s)return s(r,!0);var u=new Error("Cannot find module '"+r+"'");throw u.code="MODULE_NOT_FOUND",u}var l=n[r]={exports:{}};e[r][0].call(l.exports,function(t){var n=e[r][1][t];return i(n?n:t)},l,l.exports,t,e,n,a)}return n[r].exports}for(var s="function"==typeof require&&require,r=0;r<a.length;r++)i(a[r]);return i}({1:[function(t,e,n){function a(t,e,n){c.arrayForEach(n,function(n){(t[n]=t[n]||[]).push(e)})}function i(t,e){c.arrayForEach(e,function(e){t.hasOwnProperty(e)||c.error("The dependency ["+e+"] does not exist")})}function s(t){var e=t.deps;return t instanceof r&&t.initialDeps&&c.arrayForEach(t.initialDeps,function(t){c.arrayIndexOf(e,t)===-1&&e.push(t)}),e}var r=(t("./nodes/CascadeNode"),t("./nodes/CascadeDataState")),o=(t("./nodes/CascadeDataDerive"),t("./nodes/CascadeWait")),c=t("./helper/util"),u={reinitializeNodesManager:function(){this.statesObj=this.statesObj||{},this.impactGraph=this.impactGraph||{}},addNode:function(t){this.statesObj.hasOwnProperty(t.name)&&c.error("The state or drived data ["+name+"] is already defined");var e=s(t);i(this.statesObj,e),this.statesObj[t.name]=t,a(this.impactGraph,t.name,e)},removeNode:function(t){if(t&&t instanceof o){var e=this;c.arrayForEach(t.deps,function(n){var a=e.impactGraph[n];a.splice(c.arrayIndexOf(a,t.name),1)}),delete this.statesObj[t.name]}else c.error("You can only remove CascadeWait object")},removeInitialDeps:function(t){if(t instanceof r){var e=t.initialDeps,n=[];c.arrayForEach(e,function(e){c.arrayIndexOf(t.deps,e)===-1&&n.push(e)}),delete t.initialDeps,delete t.initialFactory;var a=this;c.arrayForEach(n,function(e){var n=a.impactGraph[e];n.splice(c.arrayIndexOf(n,t.name),1)})}else c.error("You can only remove initialDeps of a CascadeDataState object")},getChildren:function(t){var e=this,n=[].concat(this.impactGraph[t]||[]);return c.arrayForEach(n,function(t){c.arrayForEach(e.getChildren(t),function(t){c.arrayIndexOf(n,t)===-1&&n.push(t)})}),n}};e.exports={Mixin:u}},{"./helper/util":5,"./nodes/CascadeDataDerive":6,"./nodes/CascadeDataState":7,"./nodes/CascadeNode":8,"./nodes/CascadeWait":9}],2:[function(t,e,n){/**
 * @preserve Cascade.js
 *
 * @version 1.1.0
 * @copyright The Financial Times Limited [All Rights Reserved]
 * @license https://github.com/hanjunspirit/cascade.js/blob/master/LICENSE
 */
"use strict";function a(){this.states={},this._requireIdx=0,this.subscribers=[],this.reinitializeTransaction(),this.reinitializeNodesManager()}function i(){}function s(t){return t instanceof o}var r=t("./helper/Transaction"),o=t("./helper/UglyPromise"),c=t("./helper/util"),u=(t("./nodes/CascadeNode"),t("./nodes/CascadeDataState")),l=t("./nodes/CascadeDataDerive"),f=t("./nodes/CascadeWait"),d=t("./NodesManager");c.assign(a.prototype,r.Mixin,d.Mixin,{define:function(t,e,n,a,i){this.addNode(new u(t,e,n,a,i)),this.batchedUpdate(function(){this.adjust(t),this.updatedStates[t]=this.getState(t)})},derive:function(t,e,n){this.addNode(new l(t,e,n)),this.batchedUpdate(function(){this.adjust(t),this.updatedStates[t]=this.getState(t)})},wait:function(t,e){var n="__require__"+this._requireIdx++;this.addNode(new f(n,t,e)),this.batchedUpdate(function(){this.adjust(n)})},forceUpdate:function(t){var e=this.statesObj[t];e&&e.isClean()&&(e.setDirty(),this.batchedUpdate(function(){this.adjust(t)}))},getStates:function(){var t={};for(var e in this.statesObj){var n=this.statesObj[e];n instanceof f||(t[e]=n.isClean()?this.states[e]:null)}return t},getState:function(t){var e=this.statesObj[t];return!e||!e.isClean()||e instanceof f?null:this.states[t]},setState:function(t,e){var n=this.statesObj[t];if(n){if(n instanceof l&&c.error("You can not set a derived data!"),n.isPending())return void c.warning("You can't set a pending state!");var a=n.definition,i=this.states[t];this.states[t]=a.setter(e,i),this.batchedUpdate(function(){i!==this.states[t]&&(this.updatedStates[t]=this.states[t],this._adjustChildren(t))},this)}},_adjustChildren:function(t){var e=this.getChildren(t),n=this;c.arrayForEach(e,function(t){n.statesObj[t].setDirty()}),c.arrayForEach(e,function(t){n.adjust(t),!n.statesObj[t]||n.statesObj[t]instanceof f||(n.updatedStates[t]=n.getState(t))})},adjust:function(t){var e=this.statesObj[t];if(e.isDirty()){if(!this._isInTransaction)return void c.error("adjust calls must be in Transaction");var n=e.deps;e instanceof u&&e.hasOwnProperty("initialFactory")&&(n=n.concat(e.initialDeps));var r=this;if(c.arraySome(n,function(t){return r.adjust(t),r.statesObj[t].isPending()}))e.setPending();else if(e instanceof u){var o=c.arrayMap(e.deps,function(t){return r.states[t]}),d=e.definition="function"!=typeof e.factory?a.types.Fixed(e.factory):e.factory.apply(null,o);if(d instanceof i||c.error("Empty definition in state"+t),e.hasOwnProperty("initialFactory")){if("function"==typeof e.initialFactory)var h=c.arrayMap(e.initialDeps,function(t){return r.states[t]}),p=e.initialFactory.apply(null,h);else var p=e.initialFactory;this.states[t]=d.setter(p),this.removeInitialDeps(e)}else this.states[t]=d.setter(this.states[t]);e.setClean()}else if(e instanceof l){var o=c.arrayMap(e.deps,function(t){return r.states[t]}),y=this.states[t]=e.factory.apply(null,o);if(s(y)){var v=function(n){y===r.states[t]&&r.batchedUpdate(function(){this.states[t]=n,this.updatedStates[t]=this.states[t],e.setDirty(),e.setClean(),this._adjustChildren(t)})};y.then(function(t){return v(t)},function(){return v(null)}),e.setPending()}else e.setClean()}else e instanceof f&&("function"==typeof e.factory&&this.waitToExecs.push(function(){var t=c.arrayMap(e.deps,function(t){return r.states[t]});e.factory.apply(null,t)}),this.removeNode(this.statesObj[t]))}},batchedUpdate:function(t){this._isInTransaction?t.call(this):this.perform(t,this)},subscribe:function(t){c.arrayIndexOf(this.subscribers,t)===-1&&this.subscribers.push(t)},unsubscribe:function(t){var e=c.arrayIndexOf(this.subscribers,t);e!==-1&&this.subscribers.splice(e,1)},getTransactionWrappers:function(){return[h,p]}});var h={initialize:function(){this.waitToExecs=[]},close:function(){for(var t;t=this.waitToExecs.shift();)t()}},p={initialize:function(){this.updatedStates={}},close:function(){var t=0;for(var e in this.updatedStates)t++;if(t>0){var n=this;c.arrayForEach(this.subscribers,function(t){t(n.updatedStates)})}this.updatedStates={}}};a.extendDataType=function(t){function e(t){this.args=t}return e.prototype={setter:function(e,n){return t.apply(null,[e,n].concat(this.args))}},c.extendClass(e,i),function(){return new e(Array.prototype.slice.call(arguments))}},a.types={},a.types.Fixed=a.extendDataType(function(t,e,n){return n}),a.types.Any=a.extendDataType(function(t,e){return t}),a.types.Enum=a.extendDataType(function(t,e,n){return c.arrayIndexOf(n,t)!==-1?t:void 0!==e?e:n[0]}),a.async=function(t){return new o(t)},e.exports=a},{"./NodesManager":1,"./helper/Transaction":3,"./helper/UglyPromise":4,"./helper/util":5,"./nodes/CascadeDataDerive":6,"./nodes/CascadeDataState":7,"./nodes/CascadeNode":8,"./nodes/CascadeWait":9}],3:[function(t,e,n){"use strict";var a={reinitializeTransaction:function(){this.transactionWrappers=this.getTransactionWrappers(),this.wrapperInitData?this.wrapperInitData.length=0:this.wrapperInitData=[],this._isInTransaction=!1},_isInTransaction:!1,getTransactionWrappers:null,isInTransaction:function(){return!!this._isInTransaction},perform:function(t,e,n,a,i,s,r,o){var c,u;try{this._isInTransaction=!0,c=!0,this.initializeAll(0),u=t.call(e,n,a,i,s,r,o),c=!1}finally{try{if(c)try{this.closeAll(0)}catch(t){}else this.closeAll(0)}finally{this._isInTransaction=!1}}return u},initializeAll:function(t){for(var e=this.transactionWrappers,n=t;n<e.length;n++){var a=e[n];try{this.wrapperInitData[n]=i.OBSERVED_ERROR,this.wrapperInitData[n]=a.initialize?a.initialize.call(this):null}finally{if(this.wrapperInitData[n]===i.OBSERVED_ERROR)try{this.initializeAll(n+1)}catch(t){}}}},closeAll:function(t){for(var e=this.transactionWrappers,n=t;n<e.length;n++){var a,s=e[n],r=this.wrapperInitData[n];try{a=!0,r!==i.OBSERVED_ERROR&&s.close&&s.close.call(this,r),a=!1}finally{if(a)try{this.closeAll(n+1)}catch(t){}}}this.wrapperInitData.length=0}},i={Mixin:a,OBSERVED_ERROR:{}};e.exports=i},{}],4:[function(t,e,n){function a(t){function e(t){n.status="Resolved",n.resolvedValue=n.resolvedValue;for(var e=0;e<n.onResolveCallback.length;e++)n.onResolveCallback[e].call(null,t);n.onResolveCallback[e]=[]}this.status="Pending",this.onResolveCallback=[],this.resolvedValue=null;var n=this;t(e)}a.prototype.then=function(t){"Pending"===this.status?t&&this.onResolveCallback.push(t):t&&t.call(null,this.resolvedValue)},e.exports=a},{}],5:[function(t,e,n){function a(t){"undefined"!=typeof console&&console.warn(t)}function i(t){throw"undefined"!=typeof console&&console.error(t),new Error(t)}function s(t,e){for(var n=0;n<t.length;n++)e(t[n],n)}function r(t,e){for(var n in t)if(e(t[n],n))return!0;return!1}function o(t,e){var n=[];return s(t,function(t,a){n.push(e(t,a))}),n}function c(t,e){for(var n=0;n<t.length;n++)if(t[n]===e)return n;return-1}function u(t){s(Array.prototype.slice.call(arguments,1),function(e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})}function l(t,e){var n=function(){};n.prototype=e.prototype;var a=new n;u(a,t.prototype),t.prototype=a,t.prototype.constructor=t}e.exports={warning:a,error:i,arrayForEach:s,arraySome:r,arrayMap:o,arrayIndexOf:c,assign:u,extendClass:l}},{}],6:[function(t,e,n){function a(t,e,n){s.call(this,t,e),t||error("Invalid name in defining derived data"),"function"!=typeof n&&error("Invalid factory in defining derived data "+t),this.factory=n}var i=t("../helper/util"),s=t("./CascadeNode");i.assign(a.prototype,s.prototype),e.exports=a},{"../helper/util":5,"./CascadeNode":8}],7:[function(t,e,n){function a(t,e,n,a,i){s.call(this,t,e),t||error("Invalid name in defining state"),void 0===n&&error("Invalid factory in defining state"),this.factory=n,void 0!==i&&(this.initialDeps=a||[],this.initialFactory=i),this.definition=null}var i=t("../helper/util"),s=t("./CascadeNode");i.assign(a.prototype,s.prototype),e.exports=a},{"../helper/util":5,"./CascadeNode":8}],8:[function(t,e,n){function a(t,e){this.name=t,this.deps=e||[],this.status=i.DIRTY}a.prototype={setDirty:function(){this.status=i.DIRTY},setPending:function(){this.status===i.DIRTY&&(this.status=i.PENDING)},setClean:function(){this.status===i.DIRTY&&(this.status=i.CLEAN)},isClean:function(){return this.status===i.CLEAN},isPending:function(){return this.status===i.PENDING},isDirty:function(){return this.status===i.DIRTY}};var i={DIRTY:1,CLEAN:2,PENDING:3};e.exports=a},{}],9:[function(t,e,n){function a(t,e,n){s.call(this,t,e),this.factory=n}var i=t("../helper/util"),s=t("./CascadeNode");i.assign(a.prototype,s.prototype),e.exports=a},{"../helper/util":5,"./CascadeNode":8}]},{},[2])(2)});